# Polybench Benchmark

This folder contains the port of the Polybench benchmark suite.

## Build the Benchmark

### Local Hardware Platform

1. Set the `buddy-mlir` toolchain environment variables:

```bash
cd buddy-mlir/build
export BUDDY_MLIR_BUILD_DIR=$PWD
export LLVM_MLIR_BUILD_DIR=$PWD/../llvm/build
```

2. Build benchmark for local platform:

```bash
cd buddy-benchmark
mkdir build && cd build
cmake -G Ninja .. \
    -DVECTORIZATION_BENCHMARKS=ON \
    -DCMAKE_BUILD_TYPE=RELEASE \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
    -DBUDDY_MLIR_BUILD_DIR=${BUDDY_MLIR_BUILD_DIR} \
    -DCMAKE_CXX_COMPILER=${LLVM_MLIR_BUILD_DIR}/bin/clang++ \
    -DCMAKE_C_COMPILER=${LLVM_MLIR_BUILD_DIR}/bin/clang \
    -DCMAKE_CXX_FLAGS=-march=native \
    -DCMAKE_C_FLAGS=-march=native
ninja vectorization-polybench-benchmark
```

3. Run the benchmark:

```bash
./bin/vectorization-polybench-benchmark run-benchmark --disable-sizes=mini,large,extralarge
```

### Cross Compile to Target Platform

**RISC-V Vector Extension**

Follow the relevant
[documentation](https://github.com/buddy-compiler/buddy-mlir/blob/main/docs/RVVEnviroment.md)
to prepare the RVV environment.

1. Set variables for the toolchain:

```bash
cd buddy-mlir/build
export BUDDY_MLIR_BUILD_DIR=$PWD
export LLVM_MLIR_BUILD_DIR=${BUDDY_MLIR_BUILD_DIR}/../llvm/build/
export BUDDY_MLIR_BUILD_CROSS_DIR=${BUDDY_MLIR_BUILD_DIR}/../build-cross-rv
export RISCV_GNU_TOOLCHAIN=${BUDDY_MLIR_BUILD_DIR}/thirdparty/riscv-gnu-toolchain
```

2. Build the benchmark for the target platform:

```bash
cd buddy-benchmark
mkdir build && cd build
cmake -G Ninja .. \
    -DVECTORIZATION_BENCHMARKS=ON \
    -DCMAKE_BUILD_TYPE=RELEASE \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
    -DCROSS_COMPILE_RVV=ON \
    -DCMAKE_SYSTEM_NAME=Linux \
    -DCMAKE_SYSTEM_PROCESSOR=riscv \
    -DCMAKE_C_COMPILER=${LLVM_MLIR_BUILD_DIR}/bin/clang \
    -DRISCV_GNU_TOOLCHAIN=${RISCV_GNU_TOOLCHAIN} \
    -DCMAKE_CXX_COMPILER=${LLVM_MLIR_BUILD_DIR}/bin/clang++ \
    -DCMAKE_C_FLAGS="-march=rv64gcv --target=riscv64-unknown-linux-gnu --sysroot=${RISCV_GNU_TOOLCHAIN}/sysroot --gcc-toolchain=${RISCV_GNU_TOOLCHAIN} -fPIC" \
    -DCMAKE_CXX_FLAGS="-march=rv64gcv --target=riscv64-unknown-linux-gnu --sysroot=${RISCV_GNU_TOOLCHAIN}/sysroot --gcc-toolchain=${RISCV_GNU_TOOLCHAIN} -fPIC" \
    -DBUDDY_MLIR_BUILD_DIR=${BUDDY_MLIR_BUILD_DIR} \
    -DBUDDY_MLIR_BUILD_CROSS_DIR=${BUDDY_MLIR_BUILD_CROSS_DIR} \
    -DBUDDY_MLIR_CROSS_LIB_DIR=${BUDDY_MLIR_BUILD_CROSS_DIR}/lib
ninja vectorization-polybench-benchmark
```

3. Transfer the compiled binary to the target platform and run it.

## Running the Benchmark

The binary `vectorization-polybench-benchmark` provides two options, `run-benchmark` and `run-validation`.

`run-benchmark` runs the benchmark with the specified sizes and prints the
execution time of each benchmark. To disable certain dataset sizes, use the
`--disable-sizes` option. For example, to disable the mini, large, and
extralarge dataset sizes, use the following command:

```bash
./bin/vectorization-polybench-benchmark run-benchmark --disable-sizes=mini,large,extralarge
```

`run-validation` runs the benchmark with the specified dataset size and output
the result to stdout. The format of output data is the same as the original
Polybench suite. So this output can be used to validate the correctness of this
port.

```bash
./bin/vectorization-polybench-benchmark run-validation mini
```

Note that the output can be very large, so it is recommended to redirect the
output to a file and compare it with the original Polybench output later.

## About this Benchmark

Most of the Polybench cases uses parametric loop bounds and sizes, which makes
it easy to run the benchmark with different dataset sizes. But there are some
that uses compile-time constant sizes (including fix-sized local arrays). The
MLIR source code here are generated by
[Polygeist](https://github.com/llvm/Polygeist) and modified manually to run on
different dataset sizes dynamically.
